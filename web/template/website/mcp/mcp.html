<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI问答系统</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
  <h1>
   
    勤云慧管
  </h1>
  <p>AI赋能，助您快速完成管理操作</p>
</div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="avatar ai-avatar">
                        <img src="robot_icon.png" alt="AI">
                        <span>AI</span>
                    </div>
                    <div class="message-content">
                        您好！我是勤云慧管，有什么可以帮助您的吗？
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="dot-flashing"></div>
                <span>AI正在思考中</span>
            </div>
            
            <div class="chat-input">
                <textarea id="userInput" placeholder="在这里输入您的问题..."></textarea>
                <div class="button-group">
                    <button id="voiceButton" onclick="triggerFileInput()" class="voice-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="sendButton" onclick="sendMessage()" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <input type="file" id="audioUpload" accept="audio/*" style="display: none;" onchange="handleAudioUpload(this)">
            </div>
        </div>
    </div>

    <script>
        // 添加按下回车键发送消息的功能
        document.getElementById('userInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            // 获取用户输入
            const userInput = document.getElementById('userInput').value.trim();
            
            // 如果用户没有输入内容，则返回
            if (!userInput) return;
            
            // 清空输入框
            document.getElementById('userInput').value = '';
            
            // 显示用户消息
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML += `
                <div class="message user-message">
                    <div class="avatar user-avatar">
                        <img src="user-avatar.png" alt="你">
                        <span>你</span>
                    </div>
                    <div class="message-content">
                        ${userInput}
                    </div>
                </div>
            `;
            
            // 滚动到最新消息
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 显示加载状态
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            try {
                // 发送请求到API
                const response = await fetch('http://localhost:8080/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: userInput })
                });
                
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                
                // 解析响应
                const data = await response.json();
                
                // 隐藏加载状态
                loading.style.display = 'none';
                
                // 显示AI回复
                chatMessages.innerHTML += `
                    <div class="message ai-message">
                        <div class="avatar ai-avatar">
                            <img src="robot_icon.png" alt="AI">
                            <span>AI</span>
                        </div>
                        <div class="message-content">
                            ${data.response || '抱歉，我无法理解您的问题。'}
                        </div>
                    </div>
                `;
                
                // 滚动到最新消息
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                // 隐藏加载状态
                loading.style.display = 'none';
                
                // 显示错误消息
                chatMessages.innerHTML += `
                    <div class="message ai-message">
                        <div class="avatar ai-avatar">
                            <img src="robot_icon.png" alt="AI">
                            <span>AI</span>
                        </div>
                        <div class="message-content">
                            抱歉，发生了错误：${error.message}。请确保API服务器正在运行。
                        </div>
                    </div>
                `;
                
                // 滚动到最新消息
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 触发文件选择
        function triggerFileInput() {
            document.getElementById('audioUpload').click();
        }

        async function uploadAudio(file) {
            const formData = new FormData();
            formData.append('audio_file', file);

            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            try {
                const response = await fetch('http://localhost:8080/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('上传失败');
                }

                const data = await response.json();
                const recognizedText = data.text;

                if (recognizedText.trim()) {
                    // 把识别到的文字填到输入框
                    const userInput = document.getElementById('userInput');
                    userInput.value = recognizedText;

                    // 自动调用发送消息函数
                    sendMessage();
                } else {
                    alert('没有识别到语音内容');
                }

            } catch (error) {
                alert('语音识别失败：' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function handleAudioUpload(input) {
            const file = input.files[0];
            if (file) {
                uploadAudio(file);
            }
        }
    </script>
</body>
</html>